---
- hosts: winservers
  become_method: runas
  vars_files:
    - ad.vars.yml
    - ad_passwords.yml
  tasks:
    - name: Set upstream DNS server
      win_dns_client:
        adapter_names: '*'
        ipv4_addresses:
        - '{{ upstream_dns_1 }}'
        - '{{ upstream_dns_2 }}'
      delegate_to: '{{ dc_address }}'

    - name: Change the hostname
      win_hostname:
        name: '{{ dc_hostname }}'
      register: res
      delegate_to: '{{ dc_address }}'
    - name: Reboot
      win_reboot:
      when: res.reboot_required
      delegate_to: '{{ dc_address }}'

    - name: Install Active Directory
      win_feature: >
           name=AD-Domain-Services
           include_management_tools=yes
           include_sub_features=yes
           state=present
      register: result
      delegate_to: '{{ dc_address }}'
    - name: Create Domain
      microsoft.ad.domain: >
         dns_domain_name='{{ domain_name }}'
         safe_mode_password='{{ recovery_password }}'
      register: ad
      delegate_to: "{{ dc_address }}"
    - name: reboot server
      win_reboot:
       msg: "Installing AD. Rebooting..."
       pre_reboot_delay: 15
      when: ad.changed
      delegate_to: "{{ dc_address }}"


    - name: Set internal DNS server
      win_dns_client:
        adapter_names: '*'
        ipv4_addresses:
        - '127.0.0.1'
      delegate_to: '{{ dc_address }}'

    - name: Create reverse DNS zone
      win_shell: "Add-DnsServerPrimaryZone -NetworkID {{reverse_dns_zone}} -ReplicationScope Forest"
      delegate_to: "{{ dc_address }}"
      retries: 30
      delay: 60
      register: result
      until: result is succeeded
